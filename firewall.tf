#Reglas firewall para grupo dmz
#Puerto 3389 es para el remote desktop protocol y el 22 para ssh
resource "azurerm_network_security_rule" "rdp_ssh_dmz" {
  name                        = "rdp_ssh_dmz"
  priority                    = 100
  direction                   = "Inbound"
  access                      = "Allow"
  protocol                    = "Tcp"
  source_port_range           = "*"
  destination_port_ranges     = ["3389", "22"]
  source_address_prefix       = "*"
  destination_address_prefix  = "*"
  resource_group_name         = azurerm_resource_group.resource_gp.name
  network_security_group_name = azurerm_network_security_group.dmzNSG.name
}

#Puerto 80 es el de HTTP, 8080 donde esta la web con la vulnerabilidad, 443 es el de HTTPS
resource "azurerm_network_security_rule" "puerto_web" {
  name                        = "puerto_web"
  priority                    = 101
  direction                   = "Inbound"
  access                      = "Allow"
  protocol                    = "Tcp"
  source_port_range           = "*"
  destination_port_ranges      = ["80", "8080", "443"]
  source_address_prefix       = "Internet"
  destination_address_prefix  = "*"
  resource_group_name         = azurerm_resource_group.resource_gp.name
  network_security_group_name = azurerm_network_security_group.dmzNSG.name
}

#Permite cualquier trafico independientemente del protocolo o destino
resource "azurerm_network_security_rule" "permitir_trafico" {
  name                        = "permitir_trafico"
  priority                    = 106
  direction                   = "Inbound"
  access                      = "Allow"
  protocol                    = "*"
  source_port_range           = "*"
  destination_port_range      = "*"
  source_address_prefix       = "Internet"
  destination_address_prefix  = "*"
  resource_group_name         = azurerm_resource_group.resource_gp.name
  network_security_group_name = azurerm_network_security_group.dmzNSG.name
}

#Reglas firewall para grupo interna
#Evita conexiones al puerto 3389 es para el remote desktop protocol
resource "azurerm_network_security_rule" "rdp_interna" {
  name                        = "rdp_interna"
  priority                    = 100
  direction                   = "Inbound"
  access                      = "Deny"
  protocol                    = "Tcp"
  source_port_range           = "*"
  destination_port_range      = "3389"
  source_address_prefix       = "Internet"
  destination_address_prefix  = "*"
  resource_group_name         = azurerm_resource_group.resource_gp.name
  network_security_group_name = azurerm_network_security_group.internaNSG.name
}

#Bloquea acceso a al red interna desde la maquina de la DMZ
resource "azurerm_network_security_rule" "dmz_subred1" {
  name                        = "block_dmz"
  priority                    = 123
  direction                   = "Inbound"
  access                      = "Deny"
  protocol                    = "*"
  source_port_range           = "*"
  destination_port_range      = "*"
  source_address_prefix       = azurerm_linux_virtual_machine.servidor_web.public_ip_address
  destination_address_prefix  = "*"
  resource_group_name         = azurerm_resource_group.resource_gp.name
  network_security_group_name = azurerm_network_security_group.internaNSG.name
}

#Puerto 22 para conexiones por ssh
resource "azurerm_network_security_rule" "permitir_ssh_internal" {
  name                        = "ssh_internal"
  priority                    = 102
  direction                   = "Inbound"
  access                      = "Allow"
  protocol                    = "Tcp"
  source_port_range           = "*"
  destination_port_range      = "22"
  source_address_prefix       = "*"
  destination_address_prefix  = "*"
  resource_group_name         = azurerm_resource_group.resource_gp.name
  network_security_group_name = azurerm_network_security_group.internaNSG.name
}

#Permite la conexion del directorio activo a la base de datos de la red interna
resource "azurerm_network_security_rule" "db"{
  name                        = "permitir_db"
  priority                    = 103
  direction                   = "Inbound"
  access                      = "Allow"
  protocol                    = "Tcp"
  source_port_range           = "*"
  destination_port_range      = "3306"
  source_address_prefix       = azurerm_windows_virtual_machine.servidor_ad.public_ip_address
  destination_address_prefix  = "*"
  resource_group_name         = azurerm_resource_group.resource_gp.name
  network_security_group_name = azurerm_network_security_group.internaNSG.name
}

#Permite la comunicacion entre maquinas de la red interna
resource "azurerm_network_security_rule" "permitir_interna1" {
  name                        = "permitir_interna1"
  priority                    = 104
  direction                   = "Inbound"
  access                      = "Allow"
  protocol                    = "*"
  source_port_range           = "*"
  destination_port_range      = "*"
  source_address_prefixes     = [azurerm_windows_virtual_machine.servidor_ad.public_ip_address, azurerm_linux_virtual_machine.servidor_db.public_ip_address]
  destination_address_prefix  = "*"
  resource_group_name         = azurerm_resource_group.resource_gp.name
  network_security_group_name = azurerm_network_security_group.internaNSG.name
}

#Bloquea pings entrantes equipos
resource "azurerm_network_security_rule" "denegar_ping" {
  name                        = "denegar_ping"
  priority                    = 105
  direction                   = "Inbound"
  access                      = "Deny"
  protocol                    = "Icmp"
  source_port_range           = "*"
  destination_port_range      = "*"
  source_address_prefix       = "*"
  destination_address_prefix  = "*"
  resource_group_name         = azurerm_resource_group.resource_gp.name
  network_security_group_name = azurerm_network_security_group.internaNSG.name
}
resource "azurerm_network_security_rule" "permitir_puertos" {
  name                        = "puertos"
  priority                    = 106
  direction                   = "Inbound"
  access                      = "Allow"
  protocol                    = "*"
  source_port_range           = "*"
  destination_port_range      = "*"
  source_address_prefix       = "*"
  destination_address_prefix  = "*"
  resource_group_name         = azurerm_resource_group.resource_gp.name
  network_security_group_name = azurerm_network_security_group.internaNSG.name
}



resource "azurerm_network_security_rule" "internet" {
  name                        = "permitir_internet"
  priority                    = 200
  direction                   = "Outbound"
  access                      = "Allow"
  protocol                    = "*"
  source_port_range           = "*"
  destination_port_range      = "*"
  source_address_prefix       = "*"
  destination_address_prefix  = "Internet"
  resource_group_name         = azurerm_resource_group.resource_gp.name
  network_security_group_name = azurerm_network_security_group.internaNSG.name
}

resource "azurerm_network_security_rule" "permitir_interna2" {
  name                        = "permitir_interna2"
  priority                    = 201
  direction                   = "Outbound"
  access                      = "Allow"
  protocol                    = "*"
  source_port_range           = "*"
  destination_port_range      = "*"
  source_address_prefixes     = [azurerm_windows_virtual_machine.servidor_ad.public_ip_address, azurerm_linux_virtual_machine.servidor_db.public_ip_address]
  destination_address_prefix  = "*"
  resource_group_name         = azurerm_resource_group.resource_gp.name
  network_security_group_name = azurerm_network_security_group.internaNSG.name
}

resource "azurerm_network_security_rule" "dmz_subred" {
  name                        = "permitir_dmz"
  priority                    = 202
  direction                   = "Outbound"
  access                      = "Allow"
  protocol                    = "*"
  source_port_range           = "*"
  destination_port_range      = "*"
  source_address_prefix       = "*"
  destination_address_prefix  = azurerm_linux_virtual_machine.servidor_web.public_ip_address
  resource_group_name         = azurerm_resource_group.resource_gp.name
  network_security_group_name = azurerm_network_security_group.internaNSG.name
}
